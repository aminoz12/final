document.addEventListener("DOMContentLoaded",async function(){const o=localStorage.getItem("sessionId");if(!o){console.log("❌ No session found, redirecting to login"),window.location.href="/";return}try{const e=await fetch(`/api/session?sessionId=${o}`);if(!e.ok){console.log("❌ Session invalid, redirecting to login"),localStorage.clear(),window.location.href="/";return}const a=await e.json();console.log("✅ Session validated:",a);const c=a.username||"Admin",i=document.getElementById("currentUser"),d=document.getElementById("currentUserInitial");i&&(i.textContent=`Bienvenue, ${c}`),d&&(d.textContent=c.charAt(0).toUpperCase())}catch(e){console.error("❌ Session validation failed:",e),localStorage.clear(),window.location.href="/";return}let t=!1;const n=document.documentElement,l=document.getElementById("modeToggle"),s=document.getElementById("sunIcon"),r=document.getElementById("moonIcon");function u(){t=!t,t?(n.classList.add("dark"),s.classList.remove("hidden"),r.classList.add("hidden")):(n.classList.remove("dark"),r.classList.remove("hidden"),s.classList.add("hidden"))}t=!0,n.classList.add("dark"),s.classList.remove("hidden"),r.classList.add("hidden"),l.addEventListener("click",u),document.getElementById("logoutBtn").addEventListener("click",async function(){this.innerHTML='<svg class="animate-spin w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Déconnexion...',this.disabled=!0;try{await fetch(`/api/session?sessionId=${o}`,{method:"DELETE"})}catch(e){console.error("❌ Failed to destroy session:",e)}localStorage.clear(),window.location.href="/"});const g=window.location.pathname;document.querySelectorAll("nav a").forEach(e=>{e.getAttribute("href")===g&&(e.classList.add("bg-blue-100","dark:bg-blue-900/40","text-blue-900","dark:text-blue-100","border-blue-300","dark:border-blue-500"),e.classList.remove("bg-white/80","dark:bg-gray-800/60","text-gray-800","dark:text-gray-200","border-gray-200/50","dark:border-gray-600/50"))})});
